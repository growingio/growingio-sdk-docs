<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/blog</id>
    <title>一站式数据增长引擎 Blog</title>
    <updated>2022-02-22T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/blog"/>
    <subtitle>一站式数据增长引擎 Blog</subtitle>
    <icon>https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/img/favicon.png</icon>
    <entry>
        <title type="html"><![CDATA[从 iOS AutoreleasePool 到编译器优化]]></title>
        <id>AutoreleasePool</id>
        <link href="https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/blog/AutoreleasePool"/>
        <updated>2022-02-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[main.m 中的 AutoreleasePool]]></summary>
        <content type="html"><![CDATA[<p>main.m 中的 AutoreleasePool
某次偶然发现main.m里的 main 函数有所变化，经过一番查询<!-- -->[1]<!-- -->，发现是从 Xcode 11 开始。
<img loading="lazy" alt="autoreleasepool" src="/growingio-sdk-docs/assets/images/autoreleasepool-1-4df69502f794f02d20d13565f6bf4099.png" width="1496" height="660">
而在此之前， main 函数的实现为：
<img loading="lazy" alt="autoreleasepool" src="/growingio-sdk-docs/assets/images/autoreleasepool-2-c84f7fd1cb36f2bd78f08b5e5a929b92.png" width="1818" height="552"></p><p>熟悉 AutoreleasePool 底层原理的同学应该都知道，在@autoreleasepool作用范围内生成的对象，在 ARC 的作用下，将加入自动释放池。如 Xcode 11 之前的 main 函数，实际内存管理将大概会展开为以下实现：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_autoreleasePoolPush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NSString </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">appDelegateClassName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NSStringFromClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AppDelegate class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&nbsp;&nbsp;</span><span class="token comment" style="color:#999988;font-style:italic">// objc_autorelease(appDelegateClassName);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_autoreleaseReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&nbsp;&nbsp;</span><span class="token comment" style="color:#999988;font-style:italic">// objc_retain(appDelegateClassName);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_retainAutoreleasedReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIApplicationMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">objc_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 对push和pop之间加入自动释放池的对象进行release操作，即[appDelegateClassName release];</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">objc_autoreleasePoolPop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> tmp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>但实际上：</p><p>UIApplicationMain函数在程序运行期间不会返回，因此这里生成的 appDelegateClassName 对象一直会处在堆上无法释放造成内存泄漏；</p><p>并且程序终止之后，所使用的的内存空间将会由系统回收，自动释放池的 drain 在这里没有意义。</p><p>新的模板代码中，将 appDelegateClassName 对象的初始化操作与UIApplicationMain分离开，展开后如下：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NSString </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_autoreleasePoolPush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  appDelegateClassName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NSStringFromClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AppDelegate class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// objc_autorelease(appDelegateClassName);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  appDelegateClassName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_autoreleaseReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// objc_retain(appDelegateClassName);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  appDelegateClassName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_retainAutoreleasedReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 未知作用，在汇编中，寄存器r0的值为0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">objc_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 对自动释放池内所有对象进行release操作，即[appDelegateClassName release];</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">objc_autoreleasePoolPop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIApplicationMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">objc_storeStrong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> tmp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>appDelegateClassName 对象还是得不到释放，程序在终止前不会执行到objc_storeStrong(&amp;appDelegateClassName, nil);。</p><p>那么修改的意义何在呢？</p><p>// Setup code that might create autoreleased objects goes here.</p><p>如果需要创建自动释放的对象，那么现在，在@autoreleasepool作用域内创建即可正常释放。</p><p><strong>注意：以上示例代码中</strong>，objc_autoreleaseReturnValue(appDelegateClassName) 其实是在 NSStringFromClass(<!-- -->[AppDelegate class]<!-- -->)中调用，这里将它提取出来方便理解。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="thread-local-storage">Thread Local Storage<a class="hash-link" href="#thread-local-storage" title="Direct link to heading">​</a></h3><p>其实在上文的伪实现中，objc_autoreleaseReturnValue(appDelegateClassName)和objc_retainAutoreleasedReturnValue(appDelegateClassName)可以去掉，这一切都归功于 AutoreleasePool 与线程局部存储（Thread Local Storage, TLS）<!-- -->[2]<!-- -->的配合。</p><p>在 arm64 架构下，objc_autoreleaseReturnValue执行时，会通过__builtin_return_address(0)判断当前函数返回地址对应的汇编指令，是否是mov fp, fp，如果是的话，将 0x1 作为 value，RETURN_DISPOSITION_KEY 作为 key，存储在 TLS 中，并直接返回 obj，不执行objc_autorelease(obj)；</p><p>相关源码如下：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// NSObject.mm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Prepare a value at +1 for return through a +0 autoreleasing convention.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">objc_autoreleaseReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">prepareOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ReturnAtPlus1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_autorelease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// objc-object.h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">ReturnDisposition</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReturnAtPlus0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ReturnAtPlus1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Try to prepare for optimized return with the given disposition (+0 or +1).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Returns true if the optimized path is successful.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Otherwise the return value must be retained and/or autoreleased as usual.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> ALWAYS_INLINE bool </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">prepareOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ReturnDisposition disposition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getReturnDisposition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ReturnAtPlus0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">callerAcceptsOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">__builtin_return_address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">disposition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setReturnDisposition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">disposition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//arm64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> ALWAYS_INLINE bool </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">callerAcceptsOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ra</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// fd 03 1d aa    mov fp, fp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// arm64 instructions are well-aligned</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ra </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xaa1d03fd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>objc_retainAutoreleasedReturnValue执行时，判断RETURN_DISPOSITION_KEY 对应 value 是否为 0x1 并重置为 0x0，是的话，则直接返回 obj，不执行objc_retain(obj)；</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// NSObject.mm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Accept a value returned through a +0 autoreleasing convention for use at +1.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">objc_retainAutoreleasedReturnValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">acceptOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ReturnAtPlus1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objc_retain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// objc-object.h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Try to accept an optimized return.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Returns the disposition of the returned object (+0 or +1).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// An un-optimized return is +0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> ALWAYS_INLINE ReturnDisposition </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">acceptOptimizedReturn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReturnDisposition disposition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getReturnDisposition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setReturnDisposition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ReturnAtPlus0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// reset to the unoptimized state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> disposition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>基于以上优化，一般情况下，由工厂方法生成的对象不再需要进入自动释放池，加快了释放过程。</p><p>另外，mov fp, fp是编译器对于objc_autoreleaseReturnValue和objc_retainAutoreleasedReturnValue连续调用所做的一个标记<!-- -->[3]<!-- -->。</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Well take a look at that. It’s added in a mov r7, r7 in each case which is a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">noop (i.e. does nothing as it moves r7 back into itself). If you examine the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary values for these instructions then you’ll see they match the values that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">we were told to compare against. The compiler has added this as a marker to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tell the objc_autoreleaseReturnValue that the caller is about to call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc_retainAutoreleasedReturnValue.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>按照以上分析，新的 main 函数模板代码中，appDelegateClassName 不会进入自动释放池，而事实上确实如此，执行以下代码：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">UIKit</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">UIKit</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">"AppDelegate.h"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_objc_autoreleasePoolPrint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    __weak NSString *a;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSString </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">appDelegateClassName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @autoreleasepool </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Setup code that might create autoreleased objects goes here.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        appDelegateClassName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NSStringFromClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AppDelegate class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_objc_autoreleasePoolPrint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIApplicationMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> appDelegateClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>lldb 打印结果为：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ##############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AUTORELEASE POOLS </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> thread </span><span class="token number" style="color:#36acaa">0x102493880</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> releases pending</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">PAGE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">placeholder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  ################  </span><span class="token function" style="color:#d73a49">POOL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">placeholder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32590</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ##############</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>可以看到自动释放池中没有 appDelegateClassName 对象。</p><p>细心的同学可能会注意到，以上代码中有个__weak修饰的 a 变量，当我们把它也加入运行代码中时，lldb 打印结果为：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ##############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AUTORELEASE POOLS </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> thread </span><span class="token number" style="color:#36acaa">0x1025ab880</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> releases pending</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x14c811000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">PAGE</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x14c811038</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  ################  POOL </span><span class="token number" style="color:#36acaa">0x14c811038</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x14c811040</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0x283f9c3e0</span><span class="token plain">  __NSCFString</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32676</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ##############</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TLS 黑魔法失灵了！</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="编译器优化">编译器优化<a class="hash-link" href="#编译器优化" title="Direct link to heading">​</a></h3><p>既然 AutoreleasePool 依据汇编层面进行了优化，那么我们便从汇编中一探究竟。</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//没有加__weak： </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x100072148</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">72</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  bl </span><span class="token number" style="color:#36acaa">0x100072478</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> symbol stub </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NSStringFromClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x10007214c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  mov x29</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x29 </span><span class="token comment" style="color:#999988;font-style:italic">//mov fp, fp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x100072150</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  bl </span><span class="token number" style="color:#36acaa">0x1000724e4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> symbol stub </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> objc_retainAutoreleasedReturnValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//加了__weak：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0b8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  bl </span><span class="token number" style="color:#36acaa">0x1001da418</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> symbol stub </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NSStringFromClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0bc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  str x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> #</span><span class="token number" style="color:#36acaa">0x8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//入栈</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0c0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">84</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  b </span><span class="token number" style="color:#36acaa">0x1001da0c4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">88</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> at main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">68</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//跳转到 main.m 68:30 继续执行，其实就是下一条指令的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0c4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">88</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  mov x29</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x29 </span><span class="token comment" style="color:#999988;font-style:italic">//mov fp, fp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0c8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">92</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  ldr x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> #</span><span class="token number" style="color:#36acaa">0x8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//出栈</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1001da0cc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">96</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  bl </span><span class="token number" style="color:#36acaa">0x1001da49c</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> symbol stub </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> objc_retainAutoreleasedReturnValue</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>描述几个基本概念：</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">父函数执行子函数前，会将寄存器中的原始值存储在栈中，即入栈；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">子函数执行后，再从栈中将内容读取到寄存器，即出栈，接着继续执行后面的指令。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">寄存器[4]：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SP(Stack Pointer)：堆栈指针寄存器，指向栈顶地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FP(Frame Pointer, R29)：帧指针寄存器，通常指向栈底地址，即指向母函数与被调用的子函数在栈中的交界</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LR(Link Register, R30)：链接寄存器，保存子函数返回后执行的下一条指令的内存地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">指令[5]：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B 函数地址：跳转到对应函数中执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BL 函数地址：将下一条指令的地址存放到 LR(R30) 寄存器中，并跳转到对应函数中执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MOV x0 x1：寄存器间传值或者寄存器与常量之间传值，即 R0 = R1，寄存器与内存之间传值用 STR </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>当加了<strong>weak修饰符后，编译器在objc_autoreleaseReturnValue和objc_retainAutoreleasedReturnValue之间加入了入栈，跳转，出栈操作，导致callerAcceptsOptimizedReturn(</strong>builtin_return_address(0))的值为 false，从而执行了objc_autorelease，加到了自动释放池之中。</p><p>通过配置编译器优化级别可以去掉这几条指令，Build Settings -&gt; Apple Clang - Code Generation -&gt; Optimization Level<!-- -->[6]<!-- --> -&gt; Debug 设置为除了 None<!-- -->[-O0]<!-- --> 以外的配置即可。运行之后，可以看到 AutoreleasePool 里不会再加入对象，但也出现一条信息：</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Project was compiled with optimization - stepping may behave oddly; variables may not be available.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>一般 Debug 下，配置为 None<!-- -->[-O0]<!-- -->，Release 下配置为 Fastest，Smallest<!-- -->[-Os]<!-- -->。那么可以确定在生产环境下，此优化正常。</p><p>相应地，对于尾调用优化在 Debug 下不起作用的情况，配置为 Faster<!-- -->[-O2]<!-- -->即可生效。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="尾调用优化">尾调用优化<a class="hash-link" href="#尾调用优化" title="Direct link to heading">​</a></h3><p>对尾调用优化的介绍，这里有 2 篇优秀的文章：</p><p>尾调用优化 - <a href="https://www.ruanyifeng.com/blog/2015/04/tail-call.html" target="_blank" rel="noopener noreferrer">https://www.ruanyifeng.com/blog/2015/04/tail-call.html</a></p><p>iOS objc_msgSend尾调用优化机制详解 - <a href="https://juejin.cn/post/6844903664050536455" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903664050536455</a></p><p>其中第二篇文章中，尾调用优化在Release模式下才会有，Debug模式下没有的情况，上一节有写到，可以通过设置 Optimization Level 解决。</p><p>LLVM 编译优化是通过 Pass 实现的，查看当前 Optimization Level 对应的 Pass arguments<!-- -->[9]<!-- -->：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// where X can be Os,O1,O2,O3 and O4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">OX </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mllvm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pass</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Arguments foo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img loading="lazy" alt="autoreleasepool" src="/growingio-sdk-docs/assets/images/autoreleasepool-3-9e9782a121c1424183afd9eff8615174.png" width="1374" height="525">
上图是Faster<!-- -->[-O2]<!-- -->对应的 Pass Arguments，可以看到其中有一项是-tailcallelim<!-- -->[10]<!-- -->，这个 Pass 针对的就是尾调用优化。</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">This file transforms calls of the current function (self recursion) followed by a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return instruction with a branch to the entry of the function, creating a loop.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This pass also implements the following extensions to the basic algorithm: 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trivial instructions between the call and return do not prevent the transformation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from taking place, though currently the analysis cannot support moving any really</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useful instructions (only dead ones). 2. This pass transforms functions that are</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prevented from being tail recursive by an associative expression to use an</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">accumulator variable, thus compiling the typical naive factorial or fib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">implementation into efficient code. 3. TRE is performed if the function returns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void, if the return returns the result returned by the call, or if the function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">returns a run-time constant on all exits from the function. It is possible, though</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unlikely, that the return returns something else (like constant 0), and can still</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">be TRE’d. It can be TRE’d if all other return instructions in the function return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the exact same value. 4. If it can prove that callees do not access their caller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack frame, they are marked as eligible for tail call elimination (by the code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">generator).</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Xcode 13.0 对应的 clang 版本为： Apple clang version 13.0.0 (clang-1300.0.29.3)，经过验证，此版本中Fast <!-- -->[-O, O1]<!-- --> 中没有-tailcallelim</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">这个 StackOverflow 回答中</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">罗列了各个级别对应的 Pass，只更新到了 version </span><span class="token number" style="color:#36acaa">6.0</span><span class="token plain">，仅作为参考</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="结语">结语<a class="hash-link" href="#结语" title="Direct link to heading">​</a></h3><p>本篇技术分享从 iOS AutoreleasePool 到 TLS 线程局部存储，进而查看汇编代码，了解编译器优化，从而扩展到尾调用优化，详细描述了整个技术原理的探索学习过程。技术学习无止境，愿你我共勉。</p><p>欢迎关注 Android 和 iOS 无埋点 SDK 3.0 开源 GitHub 仓库，了解最新进展：</p><p>Android:</p><p><a href="https://github.com/growingio/growingio-sdk-android-autotracker" target="_blank" rel="noopener noreferrer">https://github.com/growingio/growingio-sdk-android-autotracker</a> </p><p>iOS:</p><p><a href="https://github.com/growingio/growingio-sdk-ios-autotracker" target="_blank" rel="noopener noreferrer">https://github.com/growingio/growingio-sdk-ios-autotracker</a> </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="参考资料">参考资料<a class="hash-link" href="#参考资料" title="Direct link to heading">​</a></h3><p>[1]<!-- --> 如何理解 Xcode 11 模板项目中 main.m 的变化?: <a href="https://www.jianshu.com/p/63426e6bf7aa" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/63426e6bf7aa</a></p><p>[2]<!-- --> 黑幕背后的Autorelease: <a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener noreferrer">http://blog.sunnyxx.com/2014/10/15/behind-autorelease/</a></p><p>[3]<!-- --> How does objc_retainAutoreleasedReturnValue work?: <a href="https://www.galloway.me.uk/2012/02/how-does-objc_retainautoreleasedreturnvalue-work/" target="_blank" rel="noopener noreferrer">https://www.galloway.me.uk/2012/02/how-does-objc_retainautoreleasedreturnvalue-work/</a></p><p>[4]<!-- --> General-purpose Registers:  <a href="https://github.com/ARM-software/abi-aa/blob/master/aapcs64/aapcs64.rst#general-purpose-registers" target="_blank" rel="noopener noreferrer">https://github.com/ARM-software/abi-aa/blob/master/aapcs64/aapcs64.rst#general-purpose-registers</a></p><p>[5]<!-- --> A64 Data Transfer Instructions: <a href="https://developer.arm.com/documentation/dui0802/a/A64-Data-Transfer-Instructions?lang=en" target="_blank" rel="noopener noreferrer">https://developer.arm.com/documentation/dui0802/a/A64-Data-Transfer-Instructions?lang=en</a></p><p>[6]<!-- --> Compiler-Level Optimizations: <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/MOSXAppProgrammingGuide/Performance/Performance.html#//apple_ref/doc/uid/TP40010543-CH9-102307" target="_blank" rel="noopener noreferrer">https://developer.apple.com/library/archive/documentation/General/Conceptual/MOSXAppProgrammingGuide/Performance/Performance.html#//apple_ref/doc/uid/TP40010543-CH9-102307</a></p><p>[7]<!-- --> 尾调用优化: <a href="https://www.ruanyifeng.com/blog/2015/04/tail-call.html" target="_blank" rel="noopener noreferrer">https://www.ruanyifeng.com/blog/2015/04/tail-call.html</a></p><p>[8]<!-- --> iOS objc_msgSend尾调用优化机制详解: <a href="https://juejin.cn/post/6844903664050536455" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903664050536455</a></p><p>[9]<!-- --> List of optimizations available in clang and llvm opt: <a href="https://stackoverflow.com/questions/35920795/list-of-optimizations-available-in-clang-and-llvm-opt" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/35920795/list-of-optimizations-available-in-clang-and-llvm-opt</a></p><p>[10]<!-- --> -tailcallelim: Tail Call Elimination: <a href="https://llvm.org/docs/Passes.html#tailcallelim-tail-call-elimination" target="_blank" rel="noopener noreferrer">https://llvm.org/docs/Passes.html#tailcallelim-tail-call-elimination</a></p><p>[11]<!-- --> Clang optimization levels: <a href="https://stackoverflow.com/questions/15548023/clang-optimization-levels" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/15548023/clang-optimization-levels</a></p>]]></content>
        <author>
            <name>YoloMao</name>
            <uri>https://github.com/YoloMao</uri>
        </author>
        <category label="iOS" term="iOS"/>
        <category label="AutoreleasePool" term="AutoreleasePool"/>
        <category label="编译器优化" term="编译器优化"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[一文搞定前端错误捕获和上报]]></title>
        <id>JS Error</id>
        <link href="https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/blog/JS Error"/>
        <updated>2021-11-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[众所周知，几乎没有一个开发者能够做到开发时100%没有Bug，那么一旦我们的产品出了问题，快速定位问题是迫切需要做的事。好在我们在Web场景中Js运行出现异常不会导致JS引擎崩溃，最多只会终止当前执行的任务。然后逐级上抛错误，类似冒泡事件，在遇到最近的一层catch时停止上抛，如果中间都没有错误处理的catch时，直至window对象结束。那么今天就与大家一起探讨一下我们在Web场景中的异常错误数据如何收集以及如何上报。]]></summary>
        <content type="html"><![CDATA[<p>众所周知，几乎没有一个开发者能够做到开发时100%没有Bug，那么一旦我们的产品出了问题，快速定位问题是迫切需要做的事。好在我们在Web场景中Js运行出现异常不会导致JS引擎崩溃，最多只会终止当前执行的任务。然后逐级上抛错误，类似冒泡事件，在遇到最近的一层catch时停止上抛，如果中间都没有错误处理的catch时，直至window对象结束。那么今天就与大家一起探讨一下我们在Web场景中的异常错误数据如何收集以及如何上报。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="错误类型">错误类型<a class="hash-link" href="#错误类型" title="Direct link to heading">​</a></h3><p>想要获取到相对完整的异常错误数据，先要了解在Web中常见的异常错误都有哪些。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="js执行错误">Js执行错误<a class="hash-link" href="#js执行错误" title="Direct link to heading">​</a></h3><p>日常执行中主要有同步错误、语法错误、普通异步任务错误、Promise任务错误、async任务错误5种常见的异常错误。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="资源加载错误">资源加载错误<a class="hash-link" href="#资源加载错误" title="Direct link to heading">​</a></h3><p>主要有图片、script、css、font等资源的加载错误问题。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="错误捕获">错误捕获<a class="hash-link" href="#错误捕获" title="Direct link to heading">​</a></h3><p>try…catch
作为一个优秀的程序员，首先我们能想到的一定是 try…catch，那么我们直接上代码：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-1-d80675cc591deae951ec7b1991309c64.png" width="543" height="620">
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-2-ccf5c079f7806d0a27eb45dbb4281904.png" width="541" height="620"></p><p>因为资源加载标签肯定不能在代码块中执行，因此资源加载错误肯定无法捕获。</p><p>基于上图结果，我们可以小结一下try…catch的处理能力：</p><p>能捕获包裹体内的同步执行错误。</p><p>不能捕获语法错误。</p><p>不能捕获异步任务错误。</p><p>不能捕获Promise任务错误。</p><p>不能捕获资源加载错误。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="windowonerror">window.onerror<a class="hash-link" href="#windowonerror" title="Direct link to heading">​</a></h3><p>我们浏览器在window对象上还自带了一个onerror的方法：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-3-f9adf43c0a9d4ee20a5eebb2b12f726c.png" width="818" height="1225">
需要额外注意：跨域脚本加载错误只有一个“Script error”，并不能获取到错误信息。可以通过在 script 标签上添加“crossorigin”属性来解决这个问题。</p><p>基于上图结果，我们再小结一下window.onerror的处理能力：</p><p>能捕获所有同步执行错误。</p><p>不能捕获语法错误。</p><p>能捕获普通异步任务错误。</p><p>不能捕获Promise任务错误。</p><p>不能捕获async任务错误。</p><p>不能捕获资源加载错误。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="windowaddeventlistenererror">window.addEventListener(‘error’)<a class="hash-link" href="#windowaddeventlistenererror" title="Direct link to heading">​</a></h3><p>在Web页面上我们可以监听绝大多数事件，当然也包括错误事件，我们从字面意思上浅理解我们可以认为与onerror差不多，但是实际上它们俩的表现还是有一点区别，这里我们给出addEventListener额外能捕获的错误，其他与onerror基本一致：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-4-b500af01e18320d0cc1ed7b4f1c9d5d1.png" width="1089" height="287">
这里要额外注意的是：如果是在js代码中new Image() 后加载出现的错误是无法捕获的。</p><p>相比window.onerror，通过window.addEventListener的方式我们可以捕获资源加载的错误。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="windowaddeventlistenerunhandledrejection">window.addEventListener(‘unhandledrejection’)<a class="hash-link" href="#windowaddeventlistenerunhandledrejection" title="Direct link to heading">​</a></h3><p>刚才我们介绍了3种常见的错误捕获方式，但都不能捕获Promise任务的错误，这里有人会说了，Promise不是可以自己catch吗？是的，但是我相信大多数情况下我们的开发同学可能并不会为每一个Promise写一个catch，或者可能出现漏写的情况。Js为我们准备了一个“兜底方案”: unhandledrejection事件监听。它会在Promise 被reject（抛错）且没有被catch的时候触发。下面上例子：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-5-955331fd194be83c3be99306cca5cc24.png" width="1089" height="264">
当然如果我们将没有catch的Promise放在async中去执行，unhandledrejection事件监听也能捕获到。所以async任务错误unhandledrejection事件监听也是可以支持捕获的。</p><p><strong>题外话：</strong>我们可以看到这个事件的名称叫做unhandledrejection，作为一个英语词法敏锐的程序员，瞬间想到，有没有叫handledrejection的事件呢，如果有，我们是不是可以猜测作用刚好是相反呢？还真有！并且正如我们所猜测的，它是在Promise的reject做了处理（catch）后触发！这里我们就不展开谈论，有兴趣的同学可以研究一下。</p><p>回归正题，我们通过这么多例子测试了4种捕获错误的方式，总结得到下表：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-6-3891e979ef6b5de210075feba1ce0766.png" width="1374" height="303">
那么我们观察这个表格，首先可以看到语法错误，4种方式都不能捕获，但是我们一般认为语法错误不应该在执行阶段才发现，在我们的编译以及测试环节就可以检查出，所以我们不考虑将其捕获。那么其他的异常错误我们发现通过 addEventListener('onerror') + addEventListener('unhandledrejection') 的方式恰好能够覆盖5种异常错误的捕获，一起来实现一下：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-7-05df690dd6009d06d67a6e6df19550c3.png" width="1089" height="316">
把Promise及async任务中的错误捕获后用同步的逻辑抛出即可让onerror准确捕获到。</p><p>如此，我们就可以将我们Web中大部分的异常问题进行准确捕获。</p><p>接下来我们看看如何将错误问题上报至我们的服务器进行汇总。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="数据上报">数据上报<a class="hash-link" href="#数据上报" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="xmlhttprequest">XMLHttpRequest<a class="hash-link" href="#xmlhttprequest" title="Direct link to heading">​</a></h3><p>我们想要将数据传回服务器，最通用的方式当然就是ajax请求，通过浏览器的XMLHttpRequest（这里我们不讨论IE）的send方法，发送post请求数据给服务端，这里我们不再给出实现。</p><p>其缺点也很明显：</p><p>有严格的跨域限制、携带cookie问题。</p><p>上报请求可能会阻塞业务。</p><p>请求容易丢失（被浏览器强制cancel）。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="image">Image<a class="hash-link" href="#image" title="Direct link to heading">​</a></h3><p>由于浏览器对资源文件的区别对待，为了解决上面的几个问题，我们可以通过创建一个1x1大小的图片进行异步加载的方式来上报。图片天然可跨域，又能兼容所有的浏览器，而js和css等其他资源文件则可能出现安全拦截和跨域加载问题。
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-8-9049673cca52581f16f6495652d22d32.png" width="1089" height="139">
但由于是一个get请求，上报的数据量在不同的浏览器下上限不一致（2kb-8kb），这就可能出现超出长度限制而无法上报完整数据的情况。因此，图片上报也是一个“不安全”的方式。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="sendbeacon">SendBeacon<a class="hash-link" href="#sendbeacon" title="Direct link to heading">​</a></h3><p>这个方法天生就是为了数据统计而设计的，它解决了XMLHttpRequest和图片上报的绝大部分弊端：没有跨域问题、不阻塞业务，甚至能在页面unload阶段继续发送数据，完美地解决了普通请求在unload阶段被cancel导致丢数据的问题，唯一的问题就是IE并不支持。
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-9-6296605cf37ea48119499ed593259c3e.png" width="1089" height="527">
调用方式也非常简单，类似我们发送post请求：
<img loading="lazy" alt="try catch" src="/growingio-sdk-docs/assets/images/trycatch-10-01b335c85e8eba91f4cef07d8878b8b1.png" width="1089" height="354"></p><p>这里需要注意的是，sendBeacon并不像XMLHttpRequest一样可以直接指定Content-Type，且不支持application/json等常见格式。data的数据类型必须是 ArrayBufferView 或 Blob, DOMString 或者 FormData 类型的。这里给出Blob类型的示例。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="小结">小结<a class="hash-link" href="#小结" title="Direct link to heading">​</a></h3><p>基于以上3种上报方式，我们可以基本总结出，上报数据建议优先使用sendBeacon的方式，不支持的浏览器（例如IE）则降级使用图片上报，尽量避免直接使用XMLHttpRequest进行上报。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="结语">结语<a class="hash-link" href="#结语" title="Direct link to heading">​</a></h2><p>目前你虽然GrowingIO Web SDK现在并没有对这些异常错误做完整的收集（因为我们的产品重点不在这），但是我们有需要的用户可以自己实现错误捕获的逻辑并使用SDK的埋点方法进行上报。</p><p>另外，我们正在Web SDK上进行架构演进且即将完成，创新性地提供了客户自定义插件的能力！后续您可以尝试通过SDK提供的插件能力，自行开发一个错误收集的插件（甚至是性能采集插件），配合SDK原有功能就能完成业务运营数据和开发所需的错误、性能数据的采集！敬请期待！</p><p>以上就是我们今天为大家分享的Web应用Js异常错误收集的内容。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="参考文献">参考文献：<a class="hash-link" href="#参考文献" title="Direct link to heading">​</a></h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/try...catch" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/try...catch</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/unhandledrejection_event" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/Web/API/Window/unhandledrejection_event</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon</a></p>]]></content>
        <author>
            <name>Shen Xiaowei</name>
            <uri>https://github.com/Anoiing</uri>
        </author>
        <category label="JS， Error，Catch" term="JS， Error，Catch"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[MavenCentral 迁移步骤]]></title>
        <id>MavenCentral</id>
        <link href="https://growingio.github.io/growingio-sdk-docs/growingio-sdk-docs/blog/MavenCentral"/>
        <updated>2021-07-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[随着 Jcenter 服务的即将过期，我们需要一个新的仓库来发行我们的SDK.于是我们找上了 MavenCentral，并针对如何在MavenCentral提交包写了这篇文章。]]></summary>
        <content type="html"><![CDATA[<p>随着 Jcenter 服务的即将过期，我们需要一个新的仓库来发行我们的SDK.于是我们找上了 MavenCentral，并针对如何在MavenCentral提交包写了这篇文章。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="注册账号">注册账号<a class="hash-link" href="#注册账号" title="Direct link to heading">​</a></h2><p>前往 <a href="https://issues.sonatype.org/" target="_blank" rel="noopener noreferrer">sonatype</a> 注册账号，账号注册完毕后需要提个issue来申请 groupid .</p><p>如 <a href="https://issues.sonatype.org/browse/OSSRH-66388" target="_blank" rel="noopener noreferrer">OSSRH-66388</a> 所示，如果是GitHub或gitlab下的项目，可以申请 <code>io.github.&lt;yourname&gt;</code>。
如果是域名，则需要在域名的dns解析下添加 TXT 记录，如 <a href="https://issues.sonatype.org/browse/OSSRH-66397" target="_blank" rel="noopener noreferrer">OSSRH-66397</a>举例，txt前缀为OSSRH-66397 值为网址<a href="https://issues.sonatype.org/browse/OSSRH-66397" target="_blank" rel="noopener noreferrer">https://issues.sonatype.org/browse/OSSRH-66397</a>.</p><blockquote><p>在2021年2月前申请的账号，maven仓库的地址为 <a href="https://oss.sonatype.org/" target="_blank" rel="noopener noreferrer">https://oss.sonatype.org/</a>，而在之后申请的的地址为 <a href="https://s01.oss.sonatype.org/" target="_blank" rel="noopener noreferrer">https://s01.oss.sonatype.org/</a>.不过也可以在<a href="https://issues.sonatype.org/" target="_blank" rel="noopener noreferrer">sonatype</a>上提 issue 来申请变更域名地址，如这个issue所示-&gt;<a href="https://issues.sonatype.org/browse/OSSRH-66964" target="_blank" rel="noopener noreferrer">OSSRH-66964</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="maven-central">Maven Central<a class="hash-link" href="#maven-central" title="Direct link to heading">​</a></h2><p>注册结束后，可以前往<a href="https://s01.oss.sonatype.org/" target="_blank" rel="noopener noreferrer">nexus repository</a>查看自己的仓库。在仓库中一般分为两种提交方式，一种是 SNAPSHOT 版本，一种是正式版本。
两者仓库地址不同，分别为：<a href="https://s01.oss.sonatype.org/content/repositories/snapshots" target="_blank" rel="noopener noreferrer">https://s01.oss.sonatype.org/content/repositories/snapshots</a> 和 <a href="https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/" target="_blank" rel="noopener noreferrer">https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="snapshot">SNAPSHOT<a class="hash-link" href="#snapshot" title="Direct link to heading">​</a></h3><p>SNAPSHOT 版本可以在同一版本号下多次提交，当其他人拉取该版本号时会取最后提交的包，如下图所示
<img loading="lazy" alt="SNAPSHOT" src="/growingio-sdk-docs/assets/images/SNAPSHOT-df589c8a731b619549f4b193393ae814.png" width="1280" height="1316">
在 SNAPSHOT 仓库中同一个版本下多个包会通过提交日期来区分，这样别人依赖某个版本时就能获得最新更新的包。
同时 SNAPSHOT 不会对提交的包进行 <code>close</code> 操作来对其进行审核，没有一定要有 <code>javadoc</code>、<code>sources</code>、<code>GPG加密</code>等要求。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="正式版">正式版<a class="hash-link" href="#正式版" title="Direct link to heading">​</a></h3><p>提交正式版后包会先进入 <code>Staging Repositories</code>,然后需要在这里依次执行 <code>close</code> 和 <code>release</code> 操作，<code>close</code>操作会验证本次的提交的包是否包含 <code>javadoc</code>、<code>sources</code>、<code>GPG加密文件</code> 和 <code>pom</code>文件的合法等，通过后才能执行 <code>release</code> 操作向官方仓库发布。</p><p><img loading="lazy" alt="Staging Repositories" src="/growingio-sdk-docs/assets/images/Repositories-47dce28bfb4733fb20a5b42150110bf2.png" width="2084" height="764"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="开始准备">开始准备<a class="hash-link" href="#开始准备" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-配置-gpg-私钥">1. 配置 GPG 私钥<a class="hash-link" href="#1-配置-gpg-私钥" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-cmd theme-code-block"><div class="codeBlockContent_wNvx cmd"><pre tabindex="0" class="prism-code language-cmd codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># 生成证书，里面会要求输入用户名和密码，有效期两年。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --gen-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看公钥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --list-keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看私钥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --list-secret-keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将证书上传 key server，恩，国内需要代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --keyserver-options http-proxy=127.0.0.1:1087 --send-keys D81E8990E415EDE0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看8位短id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --list-keys --keyid-format short</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成私钥文件，配置到gradle使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --export-secret-keys -o secring.gpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成base64文件，后续放入github secrets 中使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base64 secring.gpg &gt; secring.gpg.b64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>具体可参考 <a href="https://central.sonatype.org/publish/requirements/gpg/" target="_blank" rel="noopener noreferrer">gpg配置</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-本地全局-gradle-配置">2. 本地全局 gradle 配置<a class="hash-link" href="#2-本地全局-gradle-配置" title="Direct link to heading">​</a></h3><p>找到 <code>.gradle</code>文件夹下gradle.properties文件，如下进行配置</p><div class="codeBlockContainer_I0IT language-gradle theme-code-block"><div class="codeBlockContent_wNvx gradle"><pre tabindex="0" class="prism-code language-gradle codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">## growingio's config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEXUS_USERNAME=&lt;sonatype账号&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEXUS_PASSWORD=&lt;sonatype密码&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signing.keyId=09B66CAF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signing.password=&lt;生成证书时的输入密码&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signing.secretKeyRingFile=&lt;生成私钥文件的文件路径&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>当然在项目下的gradle.properties也同样生效。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-配置-pom-文件">3. 配置 pom 文件<a class="hash-link" href="#3-配置-pom-文件" title="Direct link to heading">​</a></h3><p>在根项目下的 gradle.properties 添加以下配置说明，这些说明将会一一填入到 pom 文件中</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx xml"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">GROUP=com.growingio.android</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_DESCRIPTION=GrowingIO Android SDK Library.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_DEVELOPER_EMAIL=sdk-integration@growingio.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_URL=https://github.com/growingio/growingio-sdk-android-autotracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_SCM_URL=https://github.com/growingio/growingio-sdk-android-autotracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_SCM_CONNECTION=scm:git@github.com:growingio/growingio-sdk-android-autotracker.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_SCM_DEV_CONNECTION=scm:git@github.com:growingio/growingio-sdk-android-autotracker.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_LICENCE_NAME=The Apache Software License, Version 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_LICENCE_DIST=repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_DEVELOPER_ID=GrowingIo Sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_DEVELOPER_NAME=GrowingIo Sdk</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-编写gradle的maven上传代码">4. 编写gradle的maven上传代码<a class="hash-link" href="#4-编写gradle的maven上传代码" title="Direct link to heading">​</a></h3><p><a href="https://central.sonatype.org/publish/publish-gradle/" target="_blank" rel="noopener noreferrer">sonatype 的gradle教程</a> 已经过期好久了，这里推荐在 Github 上的<a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="noopener noreferrer">gradle-mvn-push</a>。后面的所有改动都基于在这个文件版本上得来的，具体如何改动在后续说明。
示例代码 <code>publishMaven.gradle</code>：</p><div class="codeBlockContainer_I0IT language-groovy theme-code-block"><div class="codeBlockContent_wNvx groovy"><pre tabindex="0" class="prism-code language-groovy codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Copyright 2021 Cpacm</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Licensed under the Apache License, Version 2.0 (the "License");</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * you may not use this file except in compliance with the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * You may obtain a copy of the License at</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *     http://www.apache.org/licenses/LICENSE-2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Unless required by applicable law or agreed to in writing, software</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * distributed under the License is distributed on an "AS IS" BASIS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * See the License for the specific language governing permissions and</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * limitations under the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Based on: https://github.com/mcxiaoke/gradle-mvn-push/blob/master/gradle-mvn-push.gradle.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * To install in a local maven repo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * 1. In the project you want to test, add mavenLocal() to the repositories list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * 2. In Project, run: ./gradlew publishToMavenLocal</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * For faster runs add: -x check when building.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apply plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'maven-publish'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apply plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'signing'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> releaseConfiguration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releaseVersion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">group </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@SuppressWarnings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GrMethodMayBeStatic"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isReleaseBuild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SNAPSHOT"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getReleaseRepositoryUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'RELEASE_REPOSITORY_URL'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> RELEASE_REPOSITORY_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getSnapshotRepositoryUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'SNAPSHOT_REPOSITORY_URL'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> SNAPSHOT_REPOSITORY_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'https://s01.oss.sonatype.org/content/repositories/snapshots/'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getRepositoryUsername</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'USERNAME'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> USERNAME </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'NEXUS_USERNAME'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> NEXUS_USERNAME </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getRepositoryPassword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'PASSWORD'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> PASSWORD </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">hasProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'NEXUS_PASSWORD'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> NEXUS_PASSWORD </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configurePom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">packaging </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_PACKAGING</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_DESCRIPTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scm </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_SCM_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_SCM_CONNECTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        developerConnection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_SCM_DEV_CONNECTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">licenses </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        license </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_LICENCE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_LICENCE_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            distribution </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_LICENCE_DIST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">developers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        developer </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_DEVELOPER_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_DEVELOPER_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            email </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POM_DEVELOPER_EMAIL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">afterEvaluate </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> project </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> isAndroidProject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'com.android.application'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'com.android.library'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        repositories </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            maven </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> releasesRepoUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getReleaseRepositoryUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> snapshotsRepoUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getSnapshotRepositoryUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isReleaseBuild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> releasesRepoUrl </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> snapshotsRepoUrl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">credentials</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PasswordCredentials</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    username </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getRepositoryUsername</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    password </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getRepositoryPassword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isAndroidProject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token function" style="color:#d73a49">androidJavadocs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Javadoc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> assembleDebug</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sourceSets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">java</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classpath </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">files</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBootClasspath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">File</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pathSeparator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// include BuildConfig.java</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classpath </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">files</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"build/generated/source/buildConfig/debug"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            excludes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'**/*.kt'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token function" style="color:#d73a49">androidJavadocsJar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Jar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> androidJavadocs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'javadoc'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from androidJavadocs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destinationDir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token function" style="color:#d73a49">androidSourcesJar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Jar</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'sources'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sourceSets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">java</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">libraryVariants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> variant </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">androidJavadocs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doFirst </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                classpath </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">files</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">javaCompileProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classpath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">files</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">File</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pathSeparator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token function" style="color:#d73a49">sourcesJar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Jar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> classes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'sources'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from sourceSets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token function" style="color:#d73a49">javadocsJar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Jar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> javadoc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'javadoc'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from javadoc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destinationDir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        artifacts </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            archives sourcesJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            archives javadocsJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">JavaVersion</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">current</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isJava8Compatible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allprojects </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Javadoc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addStringOption</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Xdoclint:none'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'-quiet'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">JavaVersion</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">current</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isJava9Compatible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allprojects </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Javadoc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addBooleanOption</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'html5'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artifacts </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isAndroidProject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            archives androidSourcesJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            archives androidJavadocsJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            archives project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bundleDebugAar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        publications </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">mavenAgent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MavenPublication</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                groupId GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                artifactId POM_ARTIFACT_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                version version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">configurePom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isAndroidProject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artifact bundleReleaseAar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artifact androidSourcesJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withXml </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> dependenciesNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'dependencies'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">configurations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> configuration </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> configuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">// api will duplicate with implementation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'releaseImplementation'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'implementation'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                configuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allDependencies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">each </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"unspecified"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"unspecified"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> groupId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> artifactId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">ProjectDependency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> properties </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDependencyProject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            groupId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            artifactId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"POM_ARTIFACT_ID"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        println </span><span class="token string" style="color:#e3116c">"dependencies:"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> groupId </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> artifactId </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> dependencyNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dependenciesNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'dependency'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'groupId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'artifactId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> artifactId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'version'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'scope'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'compile'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    from components</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artifact sourcesJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artifact javadocsJar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'java-gradle-plugin'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">pluginMaven</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MavenPublication</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    groupId GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artifactId POM_ARTIFACT_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    version version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">configurePom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    required </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isReleaseBuild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> gradle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">taskGraph</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"publish"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publications</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> publication </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sign publication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>基本使用：在需要发布的项目下添加 <code>gradle.properties</code>文件，并注明 <code>ARTIFACT_ID</code>名，如下：</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx xml"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">POM_NAME=autotracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_ARTIFACT_ID=autotracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_PACKAGING=aar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POM_DESCRIPTION=GrowingIO Android SDK AutoTracker.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>同时在 <code>build.gradle</code> 中引入该文件</p><div class="codeBlockContainer_I0IT language-gradle theme-code-block"><div class="codeBlockContent_wNvx gradle"><pre tabindex="0" class="prism-code language-gradle codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apply from: "${rootProject.projectDir}/gradle/publishMaven.gradle"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-cmd theme-code-block"><div class="codeBlockContent_wNvx cmd"><pre tabindex="0" class="prism-code language-cmd codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># 上传到本地仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./gradlew publishToMavenLocal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 上传到远程仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./gradlew publish</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-github-ci脚本">5. Github Ci脚本<a class="hash-link" href="#5-github-ci脚本" title="Direct link to heading">​</a></h3><p>GitHub上有提供 Action 这一工具，该工具可以在线上进行各种操作：比如编译，测试，校验等，所以打包上传也是可以的。</p><ol><li><p>配置 Github Secrets
<img loading="lazy" alt="Github Secrets" src="/growingio-sdk-docs/assets/images/Secrets-97c7b28c2cd437c3b4768d3bb6ae38ad.png" width="2400" height="748">
各个配置分别对应 <code>全局 gradle 配置</code> 步骤中的各个参数，其中 <code>SIGNING_SECRET_KEY_RING_FILE</code> 是秘钥文件经过 base64 后产生的字符串。</p></li><li><p>自动 close 和 release
这里直接使用 <a href="https://github.com/Codearte/gradle-nexus-staging-plugin" target="_blank" rel="noopener noreferrer">gradle-nexus-staging-plugin</a>的插件。它能通过 sonatype 的api来自动实现 <code>Staging Repositories</code>上的close和release操作</p></li><li><p>完整ci脚本</p></li></ol><div class="codeBlockContainer_I0IT language-yml theme-code-block"><div class="codeBlockContent_wNvx yml"><pre tabindex="0" class="prism-code language-yml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Publish Maven</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">release</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">types</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">published</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">publish</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up JDK 1.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">java-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Gradle 缓存配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache Gradle packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/cache@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ~/.gradle/caches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gradle</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> hashFiles('</span><span class="token important">**/*.gradle')</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">restore-keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 给 gradlew 文件授权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Grant Permission to Execute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          chmod +x gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          chmod +x gradle/publishAllToMavenLocal.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 构建项目</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build with Gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          bash ./gradle/publishAllToMavenLocal.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 解码秘钥</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Decode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo "${{secrets.SIGNING_SECRET_KEY_RING_FILE}}" &gt; ~/.gradle/secring.gpg.b64</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          base64 -d ~/.gradle/secring.gpg.b64 &gt; ~/.gradle/secring.gpg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Publish to Sonatype</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">NEXUS_USERNAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.NEXUS_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">NEXUS_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.NEXUS_PASSWORD </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew publish </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PNEXUS_USERNAME="$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NEXUS_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PNEXUS_PASSWORD="$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NEXUS_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Psigning.keyId=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.SIGNING_KEY_ID</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Psigning.password=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.SIGNING_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Psigning.secretKeyRingFile=$(echo ~/.gradle/secring.gpg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Close And Release Package</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">NEXUS_USERNAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.NEXUS_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">NEXUS_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.NEXUS_PASSWORD </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew tryCloseAndReleaseRepository </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PNEXUS_USERNAME="$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NEXUS_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PNEXUS_PASSWORD="$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NEXUS_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>至此，一套完整的自动打包系统就搭建完成了。</p><hr><p>参考资料：</p><ol><li><a href="https://docs.github.com/cn/actions/reference/events-that-trigger-workflows" target="_blank" rel="noopener noreferrer">github action</a></li><li><a href="https://docs.gradle.org/current/userguide/signing_plugin.html#sec:signatory_credentials" target="_blank" rel="noopener noreferrer">gradle 配置</a></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="附录关于在-growingio-各个仓库上遇到的几个问题">附录：关于在 GrowingIO 各个仓库上遇到的几个问题<a class="hash-link" href="#附录关于在-growingio-各个仓库上遇到的几个问题" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="gradle-plugin-插件打包">gradle plugin 插件打包<a class="hash-link" href="#gradle-plugin-插件打包" title="Direct link to heading">​</a></h3><p>plugin项目应该属于 java 项目，但在 <code>publications</code>下它会单独走 <code>pluginMaven</code>，所以需要对其做特别处理来规范其 ARTIFACT_ID</p><div class="codeBlockContainer_I0IT language-groovy theme-code-block"><div class="codeBlockContent_wNvx groovy"><pre tabindex="0" class="prism-code language-groovy codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'java-gradle-plugin'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pluginMaven</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MavenPublication</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        groupId GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        artifactId POM_ARTIFACT_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        version version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">configurePom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="javadoc找不到buildconfig文件">javadoc找不到BuildConfig文件<a class="hash-link" href="#javadoc找不到buildconfig文件" title="Direct link to heading">​</a></h3><p>这里需要在生成 javadoc 包的时候添加 BuildConfig类的路径到 classpath 中。</p><div class="codeBlockContainer_I0IT language-groovy theme-code-block"><div class="codeBlockContent_wNvx groovy"><pre tabindex="0" class="prism-code language-groovy codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">task </span><span class="token function" style="color:#d73a49">androidJavadocs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Javadoc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> assembleDebug</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sourceSets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">java</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    classpath </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">files</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">android</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBootClasspath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">File</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pathSeparator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// include BuildConfig.java</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    classpath </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">files</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"build/generated/source/buildConfig/debug"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    excludes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'**/*.kt'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>当然可能不同版本的gradle生成的地址不一样，请自己测试并添加</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="关于-uploadarchives">关于 uploadArchives<a class="hash-link" href="#关于-uploadarchives" title="Direct link to heading">​</a></h3><p>旧版本 Gradle 的task，依赖于插件 maven。现在一般都是</p><div class="codeBlockContainer_I0IT language-groovy theme-code-block"><div class="codeBlockContent_wNvx groovy"><pre tabindex="0" class="prism-code language-groovy codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apply plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'maven-publish'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">afterEvaluate </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> project </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>且在 gradle 版本 5.0后，需要将 publishing 放置在 afterEvaluate 中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="关于依赖">关于依赖<a class="hash-link" href="#关于依赖" title="Direct link to heading">​</a></h3><p>api依赖和implementation依赖会重复出现在 <code>project.configurations.all</code>循环中(api &gt; implementation)，所以只需要判断 <code>implementation</code>即可</p><div class="codeBlockContainer_I0IT language-groovy theme-code-block"><div class="codeBlockContent_wNvx groovy"><pre tabindex="0" class="prism-code language-groovy codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withXml </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> dependenciesNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'dependencies'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">configurations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> configuration </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> configuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// api will duplicate with implementation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'releaseImplementation'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'implementation'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allDependencies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">each </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"unspecified"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"unspecified"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> groupId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> artifactId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">ProjectDependency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> properties </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDependencyProject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        groupId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        artifactId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"POM_ARTIFACT_ID"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    println </span><span class="token string" style="color:#e3116c">"dependencies:"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> groupId </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> artifactId </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> dependencyNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dependenciesNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'dependency'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'groupId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'artifactId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> artifactId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'version'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dependencyNode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'scope'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'compile'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div>]]></content>
        <author>
            <name>cpacm</name>
            <uri>https://github.com/cpacm</uri>
        </author>
        <category label="scripts" term="scripts"/>
        <category label="gradle" term="gradle"/>
    </entry>
</feed>